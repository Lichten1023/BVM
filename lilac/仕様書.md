# lilac v1 仕様書

## 基本仕様

**Lilac v1** は、8ビットオペコードと可変長引数（最大3バイト）から成る最大4バイト命令を基本単位とする、64KiBアドレス空間を持つスタンドアロン型の仮想マシンである。OSの構築や高級言語の実装にも対応可能なように設計されており、レトロコンピュータの思想を踏襲しつつも、より柔軟で実用的な命令体系とメモリ構造を備えている。

- 命令長：1〜4バイト（オペコード1バイト + 引数0〜3バイト）
- レジスタ数：8本（R0〜R7、全て汎用）
- フラグレジスタ：Z（ゼロ）、N（ネガティブ）、C（キャリー）、V（オーバーフロー）
- スタック：専用領域を持ち、PUSH/POP命令で操作
- 割込み：BRK命令およびINT命令によってソフト割込み呼出可能
- BIOSルーチン：上位メモリに配置された事前定義ルーチン群をSYS命令で呼出可能
- I/O：メモリマップトI/O方式を採用し、IN/OUT命令で外部デバイスと通信
- テキスト出力：BIOSまたはVRAM操作により可能（C64風）

本VMは、仮想的なROM/RAM/スタック/I/O/BIOS領域に明確に分割されたメモリ構造を持ち、マシン語による直接制御とBIOS経由の高水準操作の双方をサポートする。

## メモリ空間
| 範囲                | 用途             | 容量     |
| ----------------- | -------------- | ------ |
| `0x0000`〜`0x1FFF` | ROM            | 8 KiB  |
| `0x2000`〜`0x9FFF` | RAM            | 32 KiB |
| `0xA000`〜`0xA7FF` | I/O            | 2 KiB  |
| `0xA800`〜`0xB7FF` | スタック           | 4 KiB  |
| `0xB800`〜`0xFFFF` | BIOS/VRAM/自由領域 | 22 KiB |
| **合計**            |                | 64 KiB |

## 命令フォーマット
| 型  | 内容               |
| -- | ---------------- |
| T0 | 引数なし             |
| T1 | レジスタ, レジスタ       |
| T2 | レジスタ, 即値8bit     |
| T3 | レジスタ, アドレス16bit  |
| T4 | アドレス16bit（ジャンプ系） |

## 命令セット
| オペコード  | バイナリ       | 引数情報  | 備考                          |
| ------ | ---------- | ----- | --------------------------- |
| NOP    | `00000000` | T0    | 何もしない                       |
| BRK    | `00000001` | T0    | ソフトウェア割込み、デバッガ呼出し           |
| JMP    | `00000010` | T4    | 絶対ジャンプ（アドレス指定）              |
| JSR    | `00000011` | T4    | サブルーチン呼び出し                  |
| RTS    | `00000100` | T0    | サブルーチンから復帰                  |
| JZ     | `00000101` | T4    | フラグZ=1ならジャンプ                |
| JNZ    | `00000110` | T4    | フラグZ=0ならジャンプ                |
| JC     | `00000111` | T4    | フラグC=1ならジャンプ                |
| JN     | `00001000` | T4    | フラグN=1ならジャンプ                |
| MOV    | `00010000` | T1    | レジスタ間コピー                    |
| LOAD   | `00010010` | T2/T3 | 即値またはメモリからレジスタにロード          |
| STORE  | `00010011` | T3    | レジスタの値をメモリに格納               |
| LDIX   | `00010100` | T1    | 間接ロード `[Rsrc] → Rdst`       |
| STIX   | `00010101` | T1    | 間接ストア `Rsrc → [Rdst]`       |
| ADD    | `00100000` | T1/T2 | 加算                          |
| SUB    | `00100001` | T1/T2 | 減算                          |
| MUL    | `00100010` | T1/T2 | 乗算                          |
| DIV    | `00100011` | T1/T2 | 除算（0除防御は実装依存）               |
| INC    | `00100100` | T1    | +1（インクリメント）                 |
| DEC    | `00100101` | T1    | −1（デクリメント）                  |
| AND    | `00110000` | T1/T2 | 論理積                         |
| OR     | `00110001` | T1/T2 | 論理和                         |
| XOR    | `00110010` | T1/T2 | 排他論理和                       |
| NOT    | `00110011` | T1    | ビット反転                       |
| SHL    | `00110100` | T1/T2 | 左シフト                        |
| SHR    | `00110101` | T1/T2 | 右シフト                        |
| CMP    | `01000000` | T1/T2 | 比較演算（フラグ設定）                 |
| TST    | `01000001` | T1    | レジスタ自己&でZ/N設定               |
| SETF   | `01000010` | T2    | フラグをマスクで直接設定                |
| PUSH   | `01010000` | T1    | レジスタをスタックに積む                |
| POP    | `01010001` | T1    | スタックからレジスタに復元               |
| PEEK   | `01010010` | T2    | SP+オフセットから読み出し              |
| MEMCPY | `01100000` | 固定長   | R0=src, R1=dst, len=16bit   |
| MEMSET | `01100001` | 固定長   | R0=dst, val=8bit, len=16bit |
| STRLEN | `01110000` | T1    | null終端文字列の長さ                |
| STRCMP | `01110001` | T1    | RsrcとRdstの文字列比較             |
| STRCPY | `01110010` | T1    | 文字列コピー                      |
| IN     | `10000000` | T3    | MMIOから読み込み                  |
| OUT    | `10000001` | T3    | MMIOへ書き出し                   |
| MAP    | `10000010` | T3    | MMUマッピング指示                  |
| SYS    | `10010000` | T2    | BIOS/OS API呼び出し             |
| INT    | `10010001` | T2    | ソフトウェア割込み呼び出し               |
| HALT   | `10010010` | T0    | 実行停止                        |
| DBG    | `10010011` | T0    | デバッグ出力・VMトレース               |
| NOP2   | `10010100` | T0    | 予備NOP命令（調整用）                |
| NOP3   | `10010101` | T0    | 〃                           |
| NOP4   | `10010110` | T0    | 〃                           |
| NOP5   | `10010111` | T0    | 〃                           |

## BIOS サブルーチン
| 命令        | hex    | 使用方法 |
| ----------- | ------ | -------- |
| PrintString | 0xB800 | 0xB801に格納されている値をASCIIコードとして読み込んで表示する |